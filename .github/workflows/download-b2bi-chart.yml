name: Fetch IBM B2Bi Helm Chart

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart version (e.g., 3.0.6)'
        required: true

jobs:
  fetch-b2bi-chart:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Download and Extract Helm Chart
      run: |
        CHART_VERSION="${{ github.event.inputs.version }}"
        CHART_FILE="ibm-b2bi-prod-${CHART_VERSION}.tgz"
        CHART_URL="https://github.com/IBM/charts/raw/master/repo/ibm-helm/${CHART_FILE}"

        echo "====================================================="
        echo "üì• Downloading Helm chart version: $CHART_VERSION"
        echo "üì¶ Target file: $CHART_FILE"
        echo "üåê URL: $CHART_URL"
        echo "====================================================="

        mkdir -p ibm/b2bi
        curl -L -o "/tmp/$CHART_FILE" "$CHART_URL"

        echo "‚úÖ Download complete. Inspecting file type:"
        file "/tmp/$CHART_FILE"

        echo "üì¶ Attempting to extract archive..."
        tar -xzvf "/tmp/$CHART_FILE" -C ibm/b2bi || {
          echo "‚ùå Extraction failed! Likely not a valid gzip file."
          exit 1
        }

    - name: Commit and Push Chart
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@users.noreply.github.com"

        git add ibm/b2bi
        git commit -m "Add IBM B2Bi Helm chart version ${{ github.event.inputs.version }}"
        git push
