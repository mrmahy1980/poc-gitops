name: Fetch IBM B2Bi Helm Chart

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart version (e.g., 3.0.6)'
        required: true

jobs:
  fetch-b2bi-chart:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Prepare
        run: |
          mkdir -p ibm/b2bi
          echo "ğŸ—ƒï¸ Clean folder state:"
          rm -rf ibm/b2bi/* || true

      - name: Download and Extract Helm Chart
        run: |
          VERSION="${{ github.event.inputs.version }}"
          FILE="ibm-b2bi-prod-${VERSION}.tgz"
          URL="https://github.com/IBM/charts/raw/master/repo/ibm-helm/${FILE}"
          TMP="/tmp/${FILE}"

          echo "ğŸ“¦ Preparing to download chart: $FILE"
          echo "ğŸ” Checking if URL is valid..."

          if curl --head --fail --silent "$URL"; then
            echo "âœ… URL exists. Proceeding with download."
          else
            echo "âŒ Chart not found at $URL"
            exit 1
          fi

          echo "ğŸ“¥ Downloading Helm chart..."
          curl -L -o "$TMP" "$URL"

          echo "ğŸ” Inspecting file type:"
          file "$TMP"

          if file "$TMP" | grep -q "gzip compressed data"; then
            echo "âœ… File is a valid gzip. Extracting..."
            tar -xzvf "$TMP" -C ibm/b2bi
          else
            echo "âŒ Downloaded file is not a valid gzip archive. Aborting."
            exit 1
          fi

      - name: Commit and Push Chart
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add ibm/b2bi
          git commit -m "Add B2Bi chart version ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push
